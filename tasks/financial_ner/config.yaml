task: "financial_ner"

# ============================================================================
# Clustering Stage Configuration
# ============================================================================
clustering:
  random_seed: 42

  # Embedding generation
  batch_size: 512

  # UMAP dimensionality reduction
  umap_n_components: 30

  # HDBSCAN clustering parameters
  hdbscan:
    min_cluster_size: 30
    min_samples: 1
    cluster_selection_epsilon: 0.16
    max_cluster_size: 250

# ============================================================================
# Evolution Stage Configuration
# ============================================================================
evolution:
  random_seed: 42
  subset_size: 5
  mu: 40
  lambda_: 120  # Offspring count for broader search
  generations: 40
  cxpb: 0.30  # Crossover probability
  mutpb: 0.55  # Mutation probability (exploration-heavy)
  tournsize: 2  # Tournament size (weak pressure for diversity)
  max_inter_prob: 0.80  # Initial inter-cluster mutation probability
  min_inter_prob: 0.10  # Minimum inter-cluster probability (exploit mode)
  hof_size: 5
  workers: 8

  # Early stopping configuration
  early_stopping: true
  early_stopping_patience: 5
  early_stopping_min_delta: 0.005  

# ============================================================================
# Evaluation Configuration
# ============================================================================
evaluation:
  validation_sample_ratio: 1.0  # Use 100% of validation data

  # Individual early stopping parameters
  early_stop_checkpoint_fraction: 0.25  # Check after 25% of validation set
  early_stop_std_multiplier: 1.0  # Removes ~16% if normal distribution
  early_stop_probability: 0.7  # Probability of stopping underperforming individuals

  # LLM evaluation parameters
  temperature: 0.0
  # max_tokens: 32

  # Prompt templates for NER evaluation
  system_prompt: |-
    You are a helpful assistant that performs Named Entity Recognition (NER) on financial text.
    Your goal is to identify financial concepts and accounting terms related to company performance, assets, liabilities, equity, revenue, and expenses.
    Only respond with the requested JSON object and nothing else.

  user_prompt: |-
    Extract named entities from the following financial text. Identify specific values (numbers, percentages, amounts) associated with 139 possible XBRL accounting tags.

    Common XBRL tags include:
      - DebtInstrumentInterestRateStatedPercentage (interest rates)
      - LineOfCreditFacilityMaximumBorrowingCapacity (credit limits)
      - EquityMethodInvestmentOwnershipPercentage (ownership percentages)
      - EffectiveIncomeTaxRateContinuingOperations (tax rates)
      - OperatingLeaseRightOfUseAsset (lease assets)
      - NumberOfOperatingSegments (segment counts)
      - BusinessCombinationConsiderationTransferred1 (acquisition amounts)

    Here are some examples:

    {examples}

    Return the results in JSON format:
      - Each key must be an XBRL tag
      - Each value must be a list of string values (the extracted numbers/amounts from the text)
      - If there are no extractable XBRL entities in the text, return an empty JSON object {{}}

    Input: '{input_text}'

# ============================================================================
# Generation Configuration
# ============================================================================
generation:
  target_num_examples: 2500  # Target number of examples (positive + negative)
  batch_size_examples: 25  # Examples to request per API call
  base_temperature: 0.7
  chunk_size: 2500  # Characters per random text sample

  system_prompt: |-
    You are an expert at Named Entity Recognition (NER) for financial documents.
    Your task is to generate training examples that help models identify financial concepts and accounting terms.
    Follow instructions carefully regarding whether to include or exclude XBRL entities.

  # Prompt for generating examples WITH XBRL entities
  positive_user_prompt: |-
    Using the following financial text as reference, generate exactly {batch_size_examples} NER training examples that CONTAIN XBRL entities.

    Financial Text:
    {text_chunk}

    For each example:
    1. Create a realistic financial sentence (extract from above, adapt, or create similar)
    2. Identify ALL relevant XBRL tags and extract the specific values (numbers, percentages, amounts)

    Use XBRL tags like:
      - DebtInstrumentInterestRateStatedPercentage
      - LineOfCreditFacilityMaximumBorrowingCapacity
      - EquityMethodInvestmentOwnershipPercentage
      - EffectiveIncomeTaxRateContinuingOperations
      - OperatingLeaseRightOfUseAsset
      - NumberOfOperatingSegments
      - BusinessCombinationConsiderationTransferred1
      - AllocatedShareBasedCompensationExpense

    Return a JSON array with exactly {batch_size_examples} objects:
    - "input": financial sentence
    - "output": dictionary mapping XBRL tags to lists of extracted values (e.g., {{"DebtInstrumentInterestRateStatedPercentage": ["5.5"], "NumberOfOperatingSegments": ["four"]}})

    IMPORTANT: ALL examples MUST have at least one XBRL tag. Create diverse examples with 1-5 tags each, varying complexity and sentence length.

  # Prompt for generating examples WITHOUT XBRL entities
  negative_user_prompt: |-
    Using the following financial text as reference, generate exactly {batch_size_examples} NER training examples that DO NOT CONTAIN any XBRL entities.

    Financial Text:
    {text_chunk}

    For each example:
    1. Create realistic financial sentences that discuss general concepts, qualitative statements, or procedural information
    2. These should be financial text that has NO extractable numeric values, dates, or specific entity names

    Return a JSON array with exactly {batch_size_examples} objects:
    - "input": financial sentence with NO extractable XBRL data
    - "output": "No XBRL associated data."

    IMPORTANT: ALL examples MUST have output set to the string "No XBRL associated data." These should be realistic financial sentences that simply don't contain extractable entities.
